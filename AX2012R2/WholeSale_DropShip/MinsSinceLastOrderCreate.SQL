USE AXDB_PROD

SELECT
-- Last Drop Ship Order Received in AX
(SELECT TOP(1) FLOOR((1.0 * DATEDIFF(SECOND, T1.CREATEDDATETIME, GETUTCDATE())) / 60) 
  FROM KRFSALESTABLEEXTENDED AS T1, SALESTABLE AS T2
  WHERE 
  -- Standard Table Joins
  T1.PARTITION = T2.PARTITION AND T1.DATAAREAID = T2.DATAAREAID AND 
  -- Specific Table Joins
  T1.SALESTABLE = T2.RECID  
  -- Drop Ship Orders: SALESORDERCATEGORY = DROPSHIP, SALESTYPE = Sales Order, SALESSTATUS <> Cancelled
  AND T1.SALESORDERCATEGORY = 'DROPSHIP' AND T2.SALESTYPE = 3 AND T2.SALESSTATUS <> 4
  ORDER BY T1.CREATEDDATETIME DESC) AS MinutesSinceLastOrder
